package com.buhov.family;

import com.buhov.family.FamilyData.*;
import com.buhov.family.FamilyDb.*;
import com.buhov.family.FamilyHttpClient.*;
import com.buhov.family.FamilyHttpClient.Entities.UserDTO;

import android.app.Application;
import android.content.Context;
import android.content.SharedPreferences;
import android.net.ConnectivityManager;
import android.preference.PreferenceManager;

public class FamilyApplication extends Application {
	
	private FamilyData familyData;
	private int currentUserId = 0;
	
	@Override
	public void onCreate() {
		super.onCreate();
	}
	
	public FamilyData getFamilyData() {
		if(this.familyData == null) {
			this.familyData = new FamilyData(this, 
					new FamilyDb(new FamilyDbHelper(this)),
					new FamilyHttpClient());
		}
		return this.familyData;
	}
	
	public UserDTO getCurrentUser() {
		SharedPreferences preferences = PreferenceManager.getDefaultSharedPreferences(this);
		String usernameKey = getResources().getString(R.string.pref_key_username);
		String passwordKey = getResources().getString(R.string.pref_key_password);
		String username = preferences.getString(usernameKey, "");
		String password = preferences.getString(passwordKey, "");
		return new UserDTO(username, password);
	}
	
	public boolean isOnline() {
		boolean onlineMode = PreferenceManager.getDefaultSharedPreferences(this)
				.getBoolean(this.getResources().getString(R.string.pref_key_online_mode), true);
		ConnectivityManager cm = (ConnectivityManager) getSystemService(Context.CONNECTIVITY_SERVICE);
		return (onlineMode && cm.getActiveNetworkInfo() != null);
	}


	public int getCurrentUserId() {
		return this.currentUserId;
	}

	public void setCurrentUserId(int currentUserId) {
		this.currentUserId = currentUserId;
	}

	public boolean currentUserExistsLocaly() {
		if(this.getCurrentUserId() == 0) {
			UserDTO currentUser = this.getCurrentUser();
			int userId = this.getFamilyData().GetLocalUserIdOrDefault(currentUser);
			if(userId == 0) {
				return false;
			}
			this.setCurrentUserId(userId);
		}
		
		return true;
	}
}
