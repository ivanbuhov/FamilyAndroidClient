package com.buhov.family;

import com.buhov.FamilyHttpClient.FamilyHttpClient;
import com.buhov.FamilyHttpClient.FamilyServiceException;
import com.buhov.FamilyHttpClient.Entities.Pedigree;
import com.buhov.FamilyHttpClient.Entities.User;
import com.buhov.FamilyHttpClient.Entities.UserDTO;

import android.os.AsyncTask;
import android.os.Bundle;
import android.preference.PreferenceManager;
import android.app.Activity;
import android.app.AlertDialog;
import android.content.Intent;
import android.content.SharedPreferences;
import android.view.Menu;
import android.view.View;

public class MyPedigreesActivity extends BaseActivity {

	private GetMyPedigreesTask myPedigreesTask = null;
	private View contentView;
	private View progressView;
	
    @Override
    protected void onCreate(Bundle savedInstanceState) {
        super.onCreate(savedInstanceState);
        setContentView(R.layout.activity_my_pedigrees);
        this.progressView = findViewById(R.id.progress_my_pedigrees);
        this.contentView = findViewById(R.id.content_my_pedigrees);
    }

    @Override
    public boolean onCreateOptionsMenu(Menu menu) {
    	super.onCreateOptionsMenu(menu);
        // Inflate the menu; this adds items to the action bar if it is present.
        getMenuInflater().inflate(R.menu.my_pedigrees, menu);
        return true;
    }
    
 // Represents an asynchronous registration task used to register a user in the system.
 	public class GetMyPedigreesTask extends AsyncTask<UserDTO, Void, Boolean> {
 		
 		private FamilyApplication application = (FamilyApplication)getApplication();
 		private Pedigree[] pedigrees;
 		private String error;
 		
 		@Override
 		protected Boolean doInBackground(UserDTO... params) {
 			try {
 				FamilyHttpClient client = this.application.getFamilyClient();
 				this.pedigrees = client.GetPedigrees(params[0]);
 				return true;
 			}
 			catch(FamilyServiceException e) {
 				this.error = e.getMessage();
 				return false;
 			}
 		}

 		@Override
 		protected void onPostExecute(final Boolean success) {
 			myPedigreesTask = null;
 			MyPedigreesActivity.this.showProgress(false, registrationFormView, registrationStatusView);

 			if (success) {
 				RegisterActivity.this.finish();
 				startActivity(new Intent(RegisterActivity.this, MyPedigreesActivity.class));
 				this.saveUserToPrefs(username, password);
 				
 			} else {
 				String title = getResources().getString(R.string.alrt_title_registration_failed);
 				String message = this.error;
 				int icon = R.drawable.ic_error;
 				AlertDialog dialog = RegisterActivity.this.getAlert(RegisterActivity.this, message, title, icon);
 				dialog.show();
 			}
 		}
 		
 		private void saveUserToPrefs(String username, String password) {
 			SharedPreferences preferences = PreferenceManager.getDefaultSharedPreferences(RegisterActivity.this);
 			String usernameKey = getResources().getString(R.string.pref_key_username);
 			String passwordKey = getResources().getString(R.string.pref_key_password);
 			preferences.edit().putString(usernameKey, username).putString(passwordKey, password).commit();
 		}

 		@Override
 		protected void onCancelled() {
 			registrationTask = null;
 			showProgress(false);
 		}
 	}
    
}
